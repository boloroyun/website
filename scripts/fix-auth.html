<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fix Authentication Cookies</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        color: #2563eb;
      }
      .card {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      button {
        background-color: #2563eb;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #1d4ed8;
      }
      button:disabled {
        background-color: #93c5fd;
        cursor: not-allowed;
      }
      .success {
        color: #16a34a;
        font-weight: bold;
      }
      .error {
        color: #dc2626;
        font-weight: bold;
      }
      .loading {
        color: #2563eb;
        font-weight: bold;
      }
      pre {
        background-color: #f1f5f9;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #2563eb;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <h1>Fix Authentication Cookies</h1>

    <div class="card">
      <h2>What This Does</h2>
      <p>
        This page will set valid authentication cookies in your browser to fix
        the "Not authenticated" issue when trying to access your orders.
      </p>
      <p>
        The cookies will be set for a valid user account with orders in the
        database.
      </p>
    </div>

    <div class="card">
      <h2>Fix Authentication</h2>
      <p>Click the buttons below to manage your authentication cookies:</p>
      <div style="display: flex; gap: 10px; margin-bottom: 15px">
        <button id="fixButton">Set Authentication Cookies</button>
        <button id="checkButton" style="background-color: #0d9488">
          Check Authentication Status
        </button>
        <button id="clearButton" style="background-color: #b91c1c">
          Clear Authentication Cookies
        </button>
      </div>
      <p id="status"></p>
    </div>

    <div class="card">
      <h2>Next Steps</h2>
      <ol>
        <li>
          After setting the cookies, go to
          <a href="http://localhost:3000/profile" target="_blank"
            >your profile page</a
          >
        </li>
        <li>Click on the "Orders" tab</li>
        <li>You should now see your orders</li>
      </ol>
    </div>

    <div class="card">
      <h2>Important Note</h2>
      <p>
        The previous approach using JavaScript to set cookies directly doesn't
        work for HttpOnly cookies, which is why we're now using a server API
        endpoint.
      </p>
      <p>
        This new approach will properly set both the HttpOnly auth-token cookie
        and the client-accessible auth-user cookie.
      </p>
    </div>

    <script>
      // Set authentication cookies
      document
        .getElementById('fixButton')
        .addEventListener('click', async function () {
          const button = document.getElementById('fixButton');
          const statusEl = document.getElementById('status');

          // Disable button and show loading
          button.disabled = true;
          statusEl.innerHTML =
            '<span class="loading"><div class="spinner"></div> Setting authentication cookies...</span>';

          try {
            // Call the server API endpoint to set cookies
            const response = await fetch('/api/debug/set-auth-cookies');

            if (response.ok) {
              const data = await response.json();
              statusEl.innerHTML =
                '<span class="success">✅ Authentication cookies set successfully!</span><br><br>' +
                '<a href="/profile" class="success">Go to your profile page</a>';

              // Enable button after success
              button.disabled = false;
            } else {
              const errorData = await response.json();
              statusEl.innerHTML = `<span class="error">❌ Error: ${errorData.error || 'Failed to set cookies'}</span>`;
              button.disabled = false;
            }
          } catch (error) {
            statusEl.innerHTML =
              `<span class="error">❌ Error: ${error.message || 'Failed to connect to server'}</span><br><br>` +
              `<p>Make sure your development server is running at http://localhost:3000</p>`;
            button.disabled = false;
          }
        });

      // Check authentication status
      document
        .getElementById('checkButton')
        .addEventListener('click', async function () {
          const button = document.getElementById('checkButton');
          const statusEl = document.getElementById('status');

          // Disable button and show loading
          button.disabled = true;
          statusEl.innerHTML =
            '<span class="loading"><div class="spinner"></div> Checking authentication status...</span>';

          try {
            // Call the server API endpoint to check auth status
            const response = await fetch('/api/debug/check-auth');

            if (response.ok) {
              const data = await response.json();
              const isAuthenticated = data.authenticated;

              let statusHtml = '';
              if (isAuthenticated) {
                statusHtml = `<span class="success">✅ You are authenticated!</span><br><br>`;
                if (
                  data.cookies &&
                  data.cookies['auth-user'] &&
                  data.cookies['auth-user'].parsed
                ) {
                  const user = data.cookies['auth-user'].parsed;
                  statusHtml += `<strong>User:</strong> ${user.username || 'Unknown'}<br>`;
                  statusHtml += `<strong>Email:</strong> ${user.email || 'Unknown'}<br>`;
                  statusHtml += `<strong>Role:</strong> ${user.role || 'Unknown'}<br><br>`;
                }
                statusHtml +=
                  '<a href="/profile" class="success">Go to your profile page</a>';
              } else {
                statusHtml = `<span class="error">❌ You are not authenticated!</span><br><br>`;
                statusHtml += `<p>Use the "Set Authentication Cookies" button to fix this.</p>`;
              }

              statusEl.innerHTML = statusHtml;
            } else {
              const errorData = await response.json();
              statusEl.innerHTML = `<span class="error">❌ Error: ${errorData.error || 'Failed to check authentication'}</span>`;
            }
          } catch (error) {
            statusEl.innerHTML =
              `<span class="error">❌ Error: ${error.message || 'Failed to connect to server'}</span><br><br>` +
              `<p>Make sure your development server is running at http://localhost:3000</p>`;
          } finally {
            button.disabled = false;
          }
        });

      // Clear authentication cookies
      document
        .getElementById('clearButton')
        .addEventListener('click', async function () {
          const button = document.getElementById('clearButton');
          const statusEl = document.getElementById('status');

          // Disable button and show loading
          button.disabled = true;
          statusEl.innerHTML =
            '<span class="loading"><div class="spinner"></div> Clearing authentication cookies...</span>';

          try {
            // Call the server API endpoint to clear auth cookies
            const response = await fetch('/api/debug/clear-auth-cookies');

            if (response.ok) {
              statusEl.innerHTML =
                '<span class="success">✅ Authentication cookies cleared successfully!</span>';
            } else {
              const errorData = await response.json();
              statusEl.innerHTML = `<span class="error">❌ Error: ${errorData.error || 'Failed to clear cookies'}</span>`;
            }
          } catch (error) {
            statusEl.innerHTML =
              `<span class="error">❌ Error: ${error.message || 'Failed to connect to server'}</span><br><br>` +
              `<p>Make sure your development server is running at http://localhost:3000</p>`;
          } finally {
            button.disabled = false;
          }
        });
    </script>
  </body>
</html>
